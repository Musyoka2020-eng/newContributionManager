<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ContriFlow</title>
    <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://www.gstatic.com https://cdnjs.cloudflare.com https://apis.google.com https://*.firebaseio.com; style-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'unsafe-inline'; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://identitytoolkit.googleapis.com https://*.googleapis.com https://cdn.jsdelivr.net https://www.gstatic.com; frame-src 'self' https://*.firebaseapp.com;"
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Modular CSS Files -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/tabs.css">
    <link rel="stylesheet" href="css/budget.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container admin-dashboard">
        <!-- Header Component -->
        <header>
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <p class="subtitle">Manage users and view financial overview</p>
        </header>

        <!-- Admin Content -->
        <main>
            <!-- Tab Navigation -->
            <nav class="tab-navigation" role="tablist">
                <div>
                    <button class="tab-btn active" data-tab="users" role="tab" aria-selected="true" aria-controls="users-tab">
                        <i class="fas fa-users"></i>
                        <span>User Management</span>
                    </button>
                    <button class="tab-btn" data-tab="financial" role="tab" aria-selected="false" aria-controls="financial-tab">
                        <i class="fas fa-chart-line"></i>
                        <span>Financial Overview</span>
                    </button>
                </div>
                <button id="back-to-app-btn" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to App
                </button>
            </nav>

            <!-- User Management Tab -->
            <div id="users-tab" class="tab-content active">
                <section class="contributions">
                    <h2><i class="fas fa-users-cog"></i> User Management</h2>
                    <div class="card">
                        <div class="table-responsive">
                            <table id="admin-users-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-user-list">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Financial Overview Tab -->
            <div id="financial-tab" class="tab-content">
                <section class="contributions">
                    <h2><i class="fas fa-chart-bar"></i> Financial Overview</h2>
                    
                    <!-- Year Selector -->
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                        <label for="year-selector" style="font-weight: 600;">Select Year:</label>
                        <select id="year-selector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 14px; background-color: var(--bg-secondary); color: var(--text-primary);">
                            <option>Loading years...</option>
                        </select>
                    </div>
                    
                    <!-- Financial Summary Cards -->
                    <div class="financial-cards">
                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-coins"></i></div>
                            <div class="card-content">
                                <div class="card-label">Total Contributions</div>
                                <div class="card-amount" id="total-contributions">0</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="card-content">
                                <div class="card-label">Total Paid</div>
                                <div class="card-amount" id="total-paid">0</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-clock"></i></div>
                            <div class="card-content">
                                <div class="card-label">Total Unpaid</div>
                                <div class="card-amount" id="total-unpaid">0</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
                            <div class="card-content">
                                <div class="card-label">Total Expenses</div>
                                <div class="card-amount" id="total-expenses">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Stats -->
                    <div class="financial-cards">
                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-percentage"></i></div>
                            <div class="card-content">
                                <div class="card-label">% Paid</div>
                                <div class="card-amount" id="percent-paid">0%</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-users"></i></div>
                            <div class="card-content">
                                <div class="card-label">Active Contributors</div>
                                <div class="card-amount" id="active-contributors">0</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-calculator"></i></div>
                            <div class="card-content">
                                <div class="card-label">Average Contribution</div>
                                <div class="card-amount" id="avg-contribution">0</div>
                            </div>
                        </div>

                        <div class="financial-card">
                            <div class="card-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="card-content">
                                <div class="card-label">Collection Rate</div>
                                <div class="card-amount" id="collection-rate">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Trends Chart -->
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Monthly Trends</h3>
                        <canvas id="monthly-chart" style="max-height: 400px;"></canvas>
                    </div>

                    <!-- Paid vs Unpaid Pie Chart -->
                    <div class="card">
                        <h3><i class="fas fa-chart-pie"></i> Payment Status Distribution</h3>
                        <div style="max-width: 400px; margin: 0 auto;">
                            <canvas id="payment-status-chart"></canvas>
                        </div>
                    </div>

                    <!-- Budget Summary -->
                    <div class="card">
                        <h3><i class="fas fa-wallet"></i> Budget Summary Across Users</h3>
                        <div id="budget-summary">
                            <p style="text-align: center;">Loading data...</p>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="card">
                        <h3><i class="fas fa-download"></i> Export Data</h3>
                        <div class="button-group">
                            <button id="export-users-csv" class="btn btn-primary">
                                <i class="fas fa-file-csv"></i> Export Users (CSV)
                            </button>
                            <button id="export-financial-csv" class="btn btn-primary">
                                <i class="fas fa-file-csv"></i> Export Financial Data (CSV)
                            </button>
                            <button id="print-report" class="btn btn-secondary">
                                <i class="fas fa-print"></i> Print Report
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>
                <i class="fas fa-copyright"></i> <span id="current-year-footer"></span> ContriFlow
                <span class="footer-separator">|</span>
                <span class="version">v2.1.0</span>
            </p>
        </footer>
    </div>

    <!-- External JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Initialize organization context from sessionStorage (must run before firebase-manager.js) -->
    <script>
        const orgContextStr = sessionStorage.getItem('orgContext');
        if (orgContextStr) {
            const orgContext = JSON.parse(orgContextStr);
            window.orgFirebaseConfig = orgContext.firebaseConfig;
            window.orgSlug = orgContext.slug;
            window.orgName = orgContext.name;
            console.log('Organization context initialized:', orgContext.slug);
        } else {
            console.warn('No organization context found in sessionStorage - redirecting to organization selection');
            window.location.href = '/pages/error-pages/no-organization.html';
        }
    </script>

    <!-- Application Core Modules -->
    <script src="js/utils.js"></script>
    <script src="js/theme-manager.js"></script>
    <script src="js/dom-manager.js"></script>
    <script src="js/templates.js"></script>
    <script src="js/firebase-manager.js"></script>
    <script src="js/admin-dashboard.js"></script>

    <!-- Initialize Admin Dashboard -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            DOMManager.init(); // Initialize DOM references before using them
            await AdminDashboard.init();
        });
    </script>
</body>

</html>
